@using HermeSoft_Fusion.Models
@{
    ViewBag.Title = "Editar Banco";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var banco = ViewBag.Banco as Banco;

    var tipos = ViewBag.TiposAsalariado as List<TipoAsalariado> ?? new();
    var seguros = ViewBag.Seguros as List<Seguro> ?? new();
    var tasas = ViewBag.Tasas as List<TasaInteres> ?? new();

    var endeudamientos = ViewBag.Endeudamientos as List<EndeudamientoMaximo> ?? new();
    var segurosSeleccionados = ViewBag.SegurosSeleccionados as List<int> ?? new();
    var escenarios = ViewBag.Escenarios as List<EscenarioTasaInteres> ?? new();
}

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Editar Banco</h4>
        <a asp-action="Index" class="btn btn-secondary">Volver</a>
    </div>

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">@ViewBag.Error</div>
    }

    @if (banco == null)
    {
        <div class="alert alert-danger">Banco no encontrado.</div>
    }
    else
    {
        <div class="card">
            <div class="card-body">

                <form asp-action="Editar" asp-controller="Banco" method="post" enctype="multipart/form-data" id="frmBancoEditar">
                    @Html.AntiForgeryToken()

                    <input type="hidden" name="idBanco" value="@banco.idBanco" />

                    <input type="hidden" name="endeudamientosJson" id="endeudamientosJson" />
                    <input type="hidden" name="segurosJson" id="segurosJson" />
                    <input type="hidden" name="escenariosJson" id="escenariosJson" />

                    <h5 class="mb-3">Información del Banco</h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" name="nombre" value="@banco.nombre" required />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Enlace web *</label>
                            <input type="url" class="form-control" name="enlace" value="@banco.enlace" required />
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Plazo máximo (años) *</label>
                            <input type="number" class="form-control" name="maxCredito" value="@banco.maxCredito" required min="1" max="100" />
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Comisión (%) *</label>
                            <input type="number" class="form-control" name="comision" value="@banco.comision" required min="0" max="100" step="0.01" />
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Honorarios abogado (%) *</label>
                            <input type="number" class="form-control" name="honorarioAbogado" value="@banco.honorarioAbogado" required min="0" max="100" step="0.01" />
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Tipo de cambio *</label>
                            <input type="text" class="form-control" name="tipoCambio" value="@banco.tipoCambio" required />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Logo (sube uno nuevo si quieres cambiarlo)</label>
                            <input type="file" class="form-control" name="logoFile" accept=".jpg,.jpeg,.png,.webp" />
                            <small class="text-muted">Si no subes uno nuevo, se mantiene el actual.</small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Logo actual</label><br />
                            <img src="@(string.IsNullOrWhiteSpace(banco.logo) ? Url.Content("~/assets/images/bancos/BAC.png") : banco.logo)"
                                 style="max-height:120px;" class="rounded" />
                        </div>
                    </div>

                    <hr />

                    <h5 class="mb-3">Endeudamiento máximo por tipo de asalariado *</h5>
                    <div class="row">
                        @foreach (var t in tipos)
                        {
                            var actual = endeudamientos.FirstOrDefault(x => x.idTipoAsalariado == t.idTipoAsalariado);
                            var valor = actual != null ? actual.porcEndeudamiento : 0;

                            <div class="col-md-4 mb-3">
                                <label class="form-label">@t.nombre (%)</label>
                                <input type="number"
                                       class="form-control endeudamiento-input"
                                       data-tipoid="@t.idTipoAsalariado"
                                       value="@valor"
                                       required min="0" max="100" step="0.01" />
                            </div>
                        }
                    </div>

                    <hr />

                    <h5 class="mb-3">Seguros *</h5>
                    <div class="row">
                        @foreach (var s in seguros)
                        {
                            var checkedAttr = segurosSeleccionados.Contains(s.idSeguro) ? "checked" : "";
                            <div class="col-md-4 mb-2">
                                <label class="form-check">
                                    <input class="form-check-input seguro-check" type="checkbox" value="@s.idSeguro" @checkedAttr />
                                    <span class="form-check-label">@s.nombre (@s.porcSeguro%)</span>
                                </label>
                            </div>
                        }
                    </div>

                    <hr />

                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Escenarios de tasas *</h5>
                        <button type="button" class="btn btn-outline-primary" id="btnAddEscenario">+ Agregar escenario</button>
                    </div>

                    <div id="listaEscenarios" class="mt-3">
                        @foreach (var esc in escenarios)
                        {
                            <div class="card mb-3 escenario-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>Escenario</strong>
                                        <button type="button" class="btn btn-sm btn-outline-danger btnRemoveEscenario">Eliminar</button>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Nombre *</label>
                                            <input type="text" class="form-control escenario-nombre" required value="@esc.nombre" />
                                        </div>

                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Tipo de tasa *</label>
                                            <select class="form-select escenario-tasa" required>
                                                @foreach (var t in tasas)
                                                {
                                                    var selected = (t.idTasaInteres == esc.idTasaInteres) ? "selected" : "";
                                                    <option value="@t.idTasaInteres" selected="@(t.idTasaInteres == esc.idTasaInteres ? "selected" : null)">
                                                        @t.nombre
                                                    </option>

                                                }
                                            </select>
                                        </div>

                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Plazo (años) *</label>
                                            <input type="number" class="form-control escenario-plazo" required min="1" max="100" value="@esc.plazo" />
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">% Adicional *</label>
                                            <input type="number" class="form-control escenario-adicional" required min="0" max="100" step="0.01" value="@esc.porcAdicional" />
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">% Dato bancario *</label>
                                            <input type="number" class="form-control escenario-dato" required min="0" max="100" step="0.01" value="@esc.porcDatoBancario" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <template id="tplEscenario">
                        <div class="card mb-3 escenario-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Escenario</strong>
                                    <button type="button" class="btn btn-sm btn-outline-danger btnRemoveEscenario">Eliminar</button>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Nombre *</label>
                                        <input type="text" class="form-control escenario-nombre" required />
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Tipo de tasa *</label>
                                        <select class="form-select escenario-tasa" required>
                                            @foreach (var t in tasas)
                                            {
                                                <option value="@t.idTasaInteres">@t.nombre</option>
                                            }
                                        </select>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Plazo (años) *</label>
                                        <input type="number" class="form-control escenario-plazo" required min="1" max="100" />
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">% Adicional *</label>
                                        <input type="number" class="form-control escenario-adicional" required min="0" max="100" step="0.01" />
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">% Dato bancario *</label>
                                        <input type="number" class="form-control escenario-dato" required min="0" max="100" step="0.01" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary">Editar Banco</button>
                        <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
                    </div>

                </form>

            </div>
        </div>
    }

</div>

@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", () => {

  const form = document.getElementById("frmBancoEditar");
  const lista = document.getElementById("listaEscenarios");
  const tpl = document.getElementById("tplEscenario");
  const btnAdd = document.getElementById("btnAddEscenario");

  btnAdd?.addEventListener("click", () => {
    lista.appendChild(tpl.content.cloneNode(true));
  });

  lista.addEventListener("click", (e) => {
    if (e.target.classList.contains("btnRemoveEscenario")) {
      e.target.closest(".escenario-card")?.remove();
    }
  });

  form.addEventListener("submit", (e) => {

    const endeudamientos = Array.from(document.querySelectorAll(".endeudamiento-input"))
      .map(inp => ({
        idTipoAsalariado: parseInt(inp.dataset.tipoid || "0", 10),
        porcEndeudamiento: parseFloat((inp.value || "0").replace(",", "."))
      }));

    const seguros = Array.from(document.querySelectorAll(".seguro-check:checked"))
      .map(chk => parseInt(chk.value || "0", 10));

    const escenarios = Array.from(document.querySelectorAll("#listaEscenarios .escenario-card"))
      .map(card => ({
        nombre: (card.querySelector(".escenario-nombre")?.value || "").trim(),
        idTasaInteres: parseInt(card.querySelector(".escenario-tasa")?.value || "0", 10),
        plazo: parseInt(card.querySelector(".escenario-plazo")?.value || "0", 10),
        porcAdicional: parseFloat((card.querySelector(".escenario-adicional")?.value || "0").replace(",", ".")),
        porcDatoBancario: parseFloat((card.querySelector(".escenario-dato")?.value || "0").replace(",", "."))
      }))
      .filter(x => x.nombre && x.idTasaInteres > 0 && x.plazo > 0);

    if (endeudamientos.length === 0) { e.preventDefault(); alert("Faltan endeudamientos."); return; }
    if (seguros.length === 0) { e.preventDefault(); alert("Seleccione al menos un seguro."); return; }
    if (escenarios.length === 0) { e.preventDefault(); alert("Agregue al menos un escenario de tasa."); return; }

    document.getElementById("endeudamientosJson").value = JSON.stringify(endeudamientos);
    document.getElementById("segurosJson").value = JSON.stringify(seguros);
    document.getElementById("escenariosJson").value = JSON.stringify(escenarios);
  });

});
</script>
}
