@using HermeSoft_Fusion.Models
@{
    ViewBag.Title = "Registro de Bancos";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var tipos = ViewBag.TiposAsalariado as List<TipoAsalariado> ?? new List<TipoAsalariado>();
    var seguros = ViewBag.Seguros as List<Seguro> ?? new List<Seguro>();
    var tasas = ViewBag.Tasas as List<TasaInteres> ?? new List<TasaInteres>();
}

<div class="container-fluid">

    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <h4 class="page-title">Registro de Bancos</h4>
            </div>
        </div>
    </div>

    @* Mensaje de error del Controller *@
    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">@ViewBag.Error</div>
    }

    <div class="card">
        <div class="card-body">

            <form asp-action="Registro" asp-controller="Banco" method="post" enctype="multipart/form-data" id="frmBanco">
                @Html.AntiForgeryToken()

                <!-- Hidden JSON -->
                <input type="hidden" name="endeudamientosJson" id="endeudamientosJson" />
                <input type="hidden" name="segurosJson" id="segurosJson" />
                <input type="hidden" name="escenariosJson" id="escenariosJson" />



                <h5 class="mb-3">Información del Banco</h5>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nombre del banco *</label>
                        <input type="text" class="form-control" name="nombre" id="nombre" required />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Enlace web *</label>
                        <input type="url" class="form-control" name="enlace" id="enlace" required placeholder="https://..." />
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">Plazo máximo de crédito (años) *</label>
                        <input type="number" class="form-control" name="maxCredito" id="maxCredito" required min="1" max="100" />
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">Comisión bancaria (%) *</label>
                        <input type="number" class="form-control" name="comision" id="comision" required min="0" max="100" step="0.01" />
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">Honorarios abogado (%) *</label>
                        <input type="number" class="form-control" name="honorarioAbogado" id="honorarioAbogado" required min="0" max="100" step="0.01" />
                    </div>

                    <div class="col-md-3 mb-3">
                        <label class="form-label">Tipo de cambio (texto) *</label>
                        <input type="text" class="form-control" name="tipoCambio" id="tipoCambio" value="CRC" required />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label">Logo del banco *</label>
                        <input type="file" class="form-control" name="logoFile" id="logoFile"
                               accept=".jpg,.jpeg,.png,.webp" required />
                        <small class="text-muted">Formatos permitidos: JPG, PNG, WEBP</small>
                    </div>
                </div>

                <hr />

                <h5 class="mb-3">Porcentaje de endeudamiento máximo por tipo de asalariado *</h5>
                <div class="row">
                    @if (tipos.Count == 0)
                    {
                        <div class="col-12">
                            <div class="alert alert-warning">
                                No hay registros en TIPOS_ASALARIADOS. Debes poblar esa tabla para continuar.
                            </div>
                        </div>
                    }
                    else
                    {
                        foreach (var t in tipos)
                        {
                            <div class="col-md-4 mb-3">
                                <label class="form-label">@t.nombre (%)</label>
                                <input type="number"
                                       class="form-control endeudamiento-input"
                                       data-tipoid="@t.idTipoAsalariado"
                                       required min="0" max="100" step="0.01"
                                       placeholder="Ej: 35.00" />
                            </div>
                        }
                    }
                </div>

                <hr />

                <h5 class="mb-3">Seguros del banco *</h5>
                @if (seguros.Count == 0)
                {
                    <div class="alert alert-warning">
                        No hay registros en SEGUROS. Debes poblar esa tabla para continuar.
                    </div>
                }
                else
                {
                    <div class="row">
                        @foreach (var s in seguros)
                        {
                            <div class="col-md-4 mb-2">
                                <label class="form-check">
                                    <input class="form-check-input seguro-check" type="checkbox" value="@s.idSeguro" />
                                    <span class="form-check-label">@s.nombre (@s.porcSeguro%)</span>
                                </label>
                            </div>
                        }
                    </div>
                }

                <hr />

                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Escenarios de tasas de interés *</h5>
                    <button type="button" class="btn btn-outline-primary" id="btnAddEscenario">
                        + Agregar escenario
                    </button>
                </div>

                <div id="listaEscenarios" class="mt-3">
                    <!-- Se agrega 1 escenario por defecto -->
                </div>
                <template id="tplEscenario">
                    <div class="card mb-3 escenario-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Escenario</strong>
                                <button type="button" class="btn btn-sm btn-outline-danger btnRemoveEscenario">Eliminar</button>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Nombre *</label>
                                    <input type="text" class="form-control escenario-nombre" required placeholder="Ej: Tasa fija 1" />
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tipo de tasa *</label>
                                    <select class="form-select escenario-tasa" required>
                                        @foreach (var t in tasas)
                                        {
                                            <option value="@t.idTasaInteres">@t.nombre</option>
                                        }
                                    </select>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Plazo (años) *</label>
                                    <input type="number" class="form-control escenario-plazo" required min="1" max="100" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">% Adicional *</label>
                                    <input type="number" class="form-control escenario-adicional" required min="0" max="100" step="0.01" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">% Dato bancario *</label>
                                    <input type="number" class="form-control escenario-dato" required min="0" max="100" step="0.01" />
                                </div>
                            </div>
                        </div>
                    </div>
                </template>


                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Registrar Banco</button>
                    <a asp-action="Index" asp-controller="Banco" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {

          const form = document.getElementById("frmBanco");
          const lista = document.getElementById("listaEscenarios");
          const tpl = document.getElementById("tplEscenario");
          const btnAdd = document.getElementById("btnAddEscenario");

          // Agrega 1 escenario por defecto
          function addEscenario() {
            const node = tpl.content.cloneNode(true);
            lista.appendChild(node);
          }

          addEscenario();

          // Botón agregar
          btnAdd?.addEventListener("click", addEscenario);

          // Botón eliminar (delegación)
          lista.addEventListener("click", (e) => {
            if (e.target.classList.contains("btnRemoveEscenario")) {
              e.target.closest(".escenario-card")?.remove();
            }
          });

          // Submit: genera JSON
          form.addEventListener("submit", (e) => {

            // Endeudamientos
            const endeudamientos = Array.from(document.querySelectorAll(".endeudamiento-input"))
              .map(inp => ({
                idTipoAsalariado: parseInt(inp.dataset.tipoid || "0", 10),
                porcEndeudamiento: parseFloat((inp.value || "0").replace(",", "."))
              }));

            if (endeudamientos.length === 0) {
              e.preventDefault();
              alert("No se detectaron inputs de endeudamiento. Revisa la clase .endeudamiento-input");
              return;
            }

            // Seguros
            const seguros = Array.from(document.querySelectorAll(".seguro-check:checked"))
              .map(chk => parseInt(chk.value || "0", 10));

            if (seguros.length === 0) {
              e.preventDefault();
              alert("Debe seleccionar al menos un seguro.");
              return;
            }

            // Escenarios
            const escenarios = Array.from(document.querySelectorAll("#listaEscenarios .escenario-card"))
              .map(card => ({
                nombre: (card.querySelector(".escenario-nombre")?.value || "").trim(),
                idTasaInteres: parseInt(card.querySelector(".escenario-tasa")?.value || "0", 10),
                plazo: parseInt(card.querySelector(".escenario-plazo")?.value || "0", 10),
                porcAdicional: parseFloat((card.querySelector(".escenario-adicional")?.value || "0").replace(",", ".")),
                porcDatoBancario: parseFloat((card.querySelector(".escenario-dato")?.value || "0").replace(",", "."))
              }))
              .filter(x => x.nombre && x.idTasaInteres > 0 && x.plazo > 0);

            if (escenarios.length === 0) {
              e.preventDefault();
              alert("Debe registrar al menos un escenario de tasa.");
              return;
            }

            // Hidden JSON
            document.getElementById("endeudamientosJson").value = JSON.stringify(endeudamientos);
            document.getElementById("segurosJson").value = JSON.stringify(seguros);
            document.getElementById("escenariosJson").value = JSON.stringify(escenarios);
          });

        });
    </script>
}

